~(when upstream_servers (apply str "upstream app_server {\n" (map (fn [s] (format "  server %s;\n" s)) upstream_servers "}")))

server {
  listen       ~{listen};
  server_name  ~{server_name};

  access_log  ~{access_log};
  ~(when root (format "root %s;" root))
  ~(when try_files (format "try_files %s;" try_files))

~{locations}

  ~(when root (format "error_page 500 502 503 504 /500.html; location = /500.html { root: %s; }" root))
}
